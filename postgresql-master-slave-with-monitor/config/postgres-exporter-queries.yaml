pg_stat_statements:
  query: |
    SELECT
      queryid,
      query,
      calls,
      total_exec_time,
      mean_exec_time,
      max_exec_time,
      min_exec_time,
      stddev_exec_time,
      rows
    FROM pg_stat_statements
    WHERE query NOT LIKE '%pg_stat_statements%'
    ORDER BY mean_exec_time DESC
    LIMIT 100
  master: true
  metrics:
    - queryid:
        usage: "LABEL"
        description: "Query ID"
    - query:
        usage: "LABEL"
        description: "Query text"
    - calls:
        usage: "COUNTER"
        description: "Number of times executed"
    - total_exec_time:
        usage: "COUNTER"
        description: "Total time spent executing this query in milliseconds"
    - mean_exec_time:
        usage: "GAUGE"
        description: "Mean execution time in milliseconds"
    - max_exec_time:
        usage: "GAUGE"
        description: "Maximum execution time in milliseconds"
    - min_exec_time:
        usage: "GAUGE"
        description: "Minimum execution time in milliseconds"
    - stddev_exec_time:
        usage: "GAUGE"
        description: "Standard deviation of execution time in milliseconds"
    - rows:
        usage: "COUNTER"
        description: "Total number of rows retrieved or affected"

pg_slow_queries:
  query: |
    SELECT
      queryid,
      LEFT(query, 200) as query_short,
      calls,
      mean_exec_time,
      total_exec_time
    FROM pg_stat_statements
    WHERE mean_exec_time > 100
      AND query NOT LIKE '%pg_stat_statements%'
    ORDER BY mean_exec_time DESC
    LIMIT 10
  master: true
  metrics:
    - queryid:
        usage: "LABEL"
        description: "Query ID"
    - query_short:
        usage: "LABEL"
        description: "Query text (truncated)"
    - calls:
        usage: "COUNTER"
        description: "Number of times executed"
    - mean_exec_time:
        usage: "GAUGE"
        description: "Mean execution time in milliseconds"
    - total_exec_time:
        usage: "COUNTER"
        description: "Total execution time in milliseconds"

pg_database_size:
  query: |
    SELECT
      pg_database.datname,
      pg_database_size(pg_database.datname) as size_bytes
    FROM pg_database
  master: true
  cache_seconds: 30
  metrics:
    - datname:
        usage: "LABEL"
        description: "Database name"
    - size_bytes:
        usage: "GAUGE"
        description: "Database size in bytes"

pg_replication_lag:
  query: |
    SELECT
      client_addr,
      application_name,
      state,
      EXTRACT(EPOCH FROM (NOW() - pg_last_xact_replay_timestamp()))::FLOAT as lag_seconds
    FROM pg_stat_replication
  master: true
  metrics:
    - client_addr:
        usage: "LABEL"
        description: "Client address"
    - application_name:
        usage: "LABEL"
        description: "Application name"
    - state:
        usage: "LABEL"
        description: "Replication state"
    - lag_seconds:
        usage: "GAUGE"
        description: "Replication lag in seconds"
